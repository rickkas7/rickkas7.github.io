<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SpiffsParticleRK: SpiffsParticleRK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SpiffsParticleRK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SpiffsParticleRK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Port of the SPIFFS library for the Particle platform</em></p>
<h2>Introduction</h2>
<p>The <a href="https://github.com/pellepl/spiffs">excellent SPIFFS library</a> provides a simple file system on a NOR flash chip. This is a port of the library for the Particle platform, with a few convenience helpers to make using it easier from C++ and using standard Particle/Arduino/Wiring APIs.</p>
<p>Both the original SPIFFS library and this port and MIT licensed, so you can use them in open-source or in closed-source commercial products without a fee or license.</p>
<h2>Flash Support</h2>
<p>This library supports SPI-connected NOR flash chips. These are typically tiny 8-SOIC surface mount chips, intended to be included on your own circuit board. There are also breadboard adapters that are available, shown in the examples below.</p>
<p>The chips are really inexpensive, less than US$0.50 in single quantities for a 1 Mbyte flash. They're available in sizes up to 16 Mbyte.</p>
<p>SPI flash is less expensive than SD cards, and do not need an adapter or card slot. Of course they're not removable.</p>
<p>The underlying <a href="https://github.com/rickkas7/SpiFlashRK">SpiFlashRK library</a> library supports SPI NOR flash from</p>
<ul>
<li>ISSI, such as a <a href="http://www.digikey.com/product-detail/en/issi-integrated-silicon-solution-inc/IS25LQ080B-JNLE/706-1331-ND/5189766">IS25LQ080B</a>.</li>
<li>Winbond, such as a <a href="https://www.digikey.com/product-detail/en/winbond-electronics/W25Q32JVSSIQ/W25Q32JVSSIQ-ND/5803981">W25Q32</a>.</li>
<li>Macronix, such as the <a href="https://www.digikey.com/product-detail/en/macronix/MX25L8006EM1I-12G/1092-1117-ND/2744800">MX25L8006EM1I-12G</a></li>
<li>The external 1 Mbyte flash on the P1 module.</li>
<li>Probably others.</li>
</ul>
<p>It is sometimes possible to find the 8-PDIP (0.3") versions suitable for plugging directly into a breadboard. Both Macronix and Winbond make them, but they're infrequently used and often not available.</p>
<p>It does not support I2C flash, SD cards, or non-flash chips like FRAM.</p>
<h2>Instantiating an SpiFlash object</h2>
<p>You typically instantiate an object to interface to the flash chip as a global variable:</p>
<div class="fragment"><div class="line">SpiFlashISSI spiFlash(SPI, A2);</div></div><!-- fragment --><p>ISSI flash connected to the primary SPI with A2 as the CS (chip select or SS).</p>
<div class="fragment"><div class="line">SpiFlashWinbond spiFlash(SPI, A2);</div></div><!-- fragment --><p>Winbond flash connected to the primary SPI with A2 as the CS (chip select or SS).</p>
<div class="fragment"><div class="line">SpiFlashWinbond spiFlash(SPI1, D5);</div></div><!-- fragment --><p>Winbond flash connected to the secondary SPI, SPI1, with D5 as the CS (chip select or SS).</p>
<div class="fragment"><div class="line">SpiFlashMacronix spiFlash(SPI1, D5);</div></div><!-- fragment --><p>Macronix flash connected to the secondary SPI, SPI1, with D5 as the CS (chip select or SS). This is the recommended for use on the E-Series module. Note that the E series requires the <a href="https://www.digikey.com/product-detail/en/macronix/MX25L8006EM1I-12G/1092-1117-ND/2744800">MX25L8006EM1I-12G</a> the 0.154", 3.90mm width 8-SOIC package.</p>
<div class="fragment"><div class="line">SpiFlashP1 spiFlash;</div></div><!-- fragment --><p>The external flash on the P1 module. This extra flash chip is entirely available for your use; it is not used by the system firmware. You can only use this on the P1; it relies on system functions that are not available on other devices.</p>
<h2>Connecting the hardware</h2>
<p>The real intention is to reflow the 8-SOIC module directly to your custom circuit board. However, for prototyping, here are some examples:</p>
<p>For the primary SPI (SPI):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Flash Alt Name  </th><th class="markdownTableHeadNone">Particle Pin  </th><th class="markdownTableHeadNone">Example Color   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SS  </td><td class="markdownTableBodyNone">CS  </td><td class="markdownTableBodyNone">A2  </td><td class="markdownTableBodyNone">White   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">SCK  </td><td class="markdownTableBodyNone">CLK  </td><td class="markdownTableBodyNone">A3  </td><td class="markdownTableBodyNone">Orange   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MISO  </td><td class="markdownTableBodyNone">DO  </td><td class="markdownTableBodyNone">A4  </td><td class="markdownTableBodyNone">Blue   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">MOSI  </td><td class="markdownTableBodyNone">D1  </td><td class="markdownTableBodyNone">A5  </td><td class="markdownTableBodyNone">Green   </td></tr>
</table>
<p>For the secondary SPI (SPI1):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Flash Alt Name  </th><th class="markdownTableHeadNone">Particle Pin  </th><th class="markdownTableHeadNone">Example Color   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SS  </td><td class="markdownTableBodyNone">CS  </td><td class="markdownTableBodyNone">D5  </td><td class="markdownTableBodyNone">White   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">SCK  </td><td class="markdownTableBodyNone">CLK  </td><td class="markdownTableBodyNone">D4  </td><td class="markdownTableBodyNone">Orange   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MISO  </td><td class="markdownTableBodyNone">DO  </td><td class="markdownTableBodyNone">D3  </td><td class="markdownTableBodyNone">Blue   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">MOSI  </td><td class="markdownTableBodyNone">D1  </td><td class="markdownTableBodyNone">D2  </td><td class="markdownTableBodyNone">Green   </td></tr>
</table>
<p>Note that the SS/CS line can be any available GPIO pin, not just the one specified in the table above.</p>
<ul>
<li>Electron using Primary SPI</li>
</ul>
<div class="image">
<img src="electron.jpg" alt="electron.jpg"/>
<div class="caption">
Electron</div></div>
<ul>
<li>Photon using Secondary SPI (SPI1)</li>
</ul>
<div class="image">
<img src="spi1.jpg" alt="spi1.jpg"/>
<div class="caption">
Photon SPI1</div></div>
<ul>
<li>Photon using Primary SPI and a poorly hand-soldered 8-SOIC adapter</li>
</ul>
<div class="image">
<img src="soic.jpg" alt="soic.jpg"/>
<div class="caption">
SOIC Adapter</div></div>
<ul>
<li>E-series evaluation kit with a <a href="https://www.digikey.com/product-detail/en/macronix/MX25L8006EM1I-12G/1092-1117-ND/2744800">Macronix MX25L8006EM1I-12G</a> soldered to the E-series module (outlined in pink).</li>
</ul>
<div class="image">
<img src="eseries.png" alt="eseries.png"/>
<div class="caption">
E-Series</div></div>
<ul>
<li>P1 module (extra flash is under the can)</li>
</ul>
<div class="image">
<img src="p1.jpg" alt="p1.jpg"/>
<div class="caption">
P1</div></div>
<h2>Using the SPIFFS API</h2>
<h3>Background</h3>
<p>A few things about SPIFFS:</p>
<ul>
<li>It's relatively small, way smaller than SDFAT at least.</li>
<li>It has the bare minimum of things you need to store files.</li>
<li>You can allocate all or part of the flash chip to SPIFFS.</li>
</ul>
<p>In particular, there are two important limitations:</p>
<ul>
<li>It does not support subdirectories; all files are in a single directory.</li>
<li>Filenames are limited to 31 characters.</li>
<li>It does not have file timestamps (modification or creation times).</li>
</ul>
<p>Within the scope of how you use SPIFFS these shouldn't be unreasonable limitations, though you should be aware.</p>
<p>Like most file systems, there are a few things you must do:</p>
<ul>
<li>You must mount the file system, typically at startup.</li>
<li>If your flash is blank, you'll need to format the file system.</li>
<li>You can iterate the top level directory to find the file names in it.</li>
<li>In order to use data in a file, you must open it and get a file handle, read or write, then close it.</li>
<li>There are a finite number of files that can be open, but you can set the maximum. The default is 4.</li>
<li>If you think the file system is corrupted, you can check and repair it.</li>
</ul>
<p>Once you get it working, there is some fine-tuning you can do:</p>
<ul>
<li>The cache size is programmable, which speeds up operations at the cost of additional RAM. The default is 2 logical blocks.</li>
<li>The logical block size is programmable. Using larger blocks can make using large files more efficient in flash storage, at the cost of more RAM and making small files less efficient in flash storage. The default is 4K, and can't be made smaller but can be made larger.</li>
</ul>
<h2>Example 1 - Simple</h2>
<p>This example should be pretty straightforward:</p>
<div class="fragment"><div class="line">#include &quot;Particle.h&quot;</div><div class="line"></div><div class="line">#include &quot;SpiffsParticleRK.h&quot;</div><div class="line"></div><div class="line">// Pick a debug level from one of these two:</div><div class="line">// SerialLogHandler logHandler;</div><div class="line">SerialLogHandler logHandler(LOG_LEVEL_TRACE);</div><div class="line"></div><div class="line">// Chose a flash configuration:</div><div class="line">SpiFlashISSI spiFlash(SPI, A2);         // ISSI flash on SPI (A pins)</div><div class="line">// SpiFlashISSI spiFlash(SPI1, D5);     // ISSI flash on SPI1 (D pins)</div><div class="line">// SpiFlashMacronix spiFlash(SPI1, D5); // Macronix flash on SPI1 (D pins), typical config for E series</div><div class="line">// SpiFlashWinbond spiFlash(SPI, A2);   // Winbond flash on SPI (A pins)</div><div class="line">// SpiFlashP1 spiFlash;                 // P1 external flash inside the P1 module</div><div class="line"></div><div class="line">// Create an object for the SPIFFS file system</div><div class="line">SpiffsParticle fs(spiFlash);</div><div class="line"></div><div class="line">void setup() {</div><div class="line">    Serial.begin();</div><div class="line"></div><div class="line">    spiFlash.begin();</div><div class="line"></div><div class="line">    fs.withPhysicalSize(1024 * 1024);</div><div class="line"></div><div class="line">    s32_t res = fs.mountAndFormatIfNecessary();</div><div class="line">    Log.info(&quot;mount res=%d&quot;, res);</div><div class="line"></div><div class="line">    if (res == SPIFFS_OK) {</div><div class="line">        SpiffsParticleFile f = fs.openFile(&quot;test&quot;, SPIFFS_O_RDWR|SPIFFS_O_CREAT);</div><div class="line">        if (f.isValid()) {</div><div class="line">            f.println(&quot;hello world&quot;);</div><div class="line"></div><div class="line">            f.seekStart();</div><div class="line"></div><div class="line">            String s = f.readStringUntil(&#39;\n&#39;);</div><div class="line">            Log.info(&quot;got: %s&quot;, s.c_str());</div><div class="line"></div><div class="line">            f.close();</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">void loop() {</div><div class="line"></div><div class="line">}</div></div><!-- fragment --><p>In more detail: </p><hr/>
<div class="fragment"><div class="line">// Pick a debug level from one of these two:</div><div class="line">// SerialLogHandler logHandler;</div><div class="line">SerialLogHandler logHandler(LOG_LEVEL_TRACE);</div></div><!-- fragment --><p>This determines the log level. If you want fewer logs, uncomment the first SerialLogHandler definition and comment out the second. </p><hr/>
<div class="fragment"><div class="line">// Chose a flash configuration:</div><div class="line">SpiFlashISSI spiFlash(SPI, A2);         // ISSI flash on SPI (A pins)</div><div class="line">// SpiFlashISSI spiFlash(SPI1, D5);     // ISSI flash on SPI1 (D pins)</div><div class="line">// SpiFlashMacronix spiFlash(SPI1, D5); // Macronix flash on SPI1 (D pins), typical config for E series</div><div class="line">// SpiFlashWinbond spiFlash(SPI, A2);   // Winbond flash on SPI (A pins)</div><div class="line">// SpiFlashP1 spiFlash;                 // P1 external flash inside the P1 module</div></div><!-- fragment --><p>This sets up an ISSI flash chip on primary SPI (SPI), with A2 as the CS (chip select or SS line). You can comment this out and uncomment one of the other lines for other configurations. </p><hr/>
<div class="fragment"><div class="line">SpiffsParticle fs(spiFlash);</div></div><!-- fragment --><p>This sets up the <a class="el" href="class_spiffs_particle.html" title="C++ wrapper for the SPIFFS library for the Particle platform. ">SpiffsParticle</a> object using that flash chip. You will typically create this object as a global variable. </p><hr/>
<div class="fragment"><div class="line">spiFlash.begin();</div><div class="line"></div><div class="line">fs.withPhysicalSize(1024 * 1024);</div><div class="line"></div><div class="line">s32_t res = fs.mountAndFormatIfNecessary();</div><div class="line">Log.info(&quot;mount res=%d&quot;, res);</div></div><!-- fragment --><p>You must call begin() on the flash object. Then you must set the size of the file system. This is 1 Mbyte. The SPIFFS file system can use only a part of the flash, if you want. It can't be resized without reformatting, however.</p>
<p>Finally, you must mount the file system. This call mounts it, if not formatted, will format it and try to mount it again. </p><hr/>
<div class="fragment"><div class="line">SpiffsParticleFile f = fs.openFile(&quot;test&quot;, SPIFFS_O_RDWR|SPIFFS_O_CREAT);</div><div class="line">if (f.isValid()) {</div><div class="line">    f.println(&quot;hello world&quot;);</div><div class="line"></div><div class="line">    f.seekStart();</div><div class="line"></div><div class="line">    String s = f.readStringUntil(&#39;\n&#39;);</div><div class="line">    Log.info(&quot;got: %s&quot;, s.c_str());</div><div class="line"></div><div class="line">    f.close();</div><div class="line">}</div></div><!-- fragment --><p>This block of code opens the file, creating it if necessary.</p>
<p>It writes the line <code>hello world</code> to the file.</p>
<p>Then it reads the line back and prints it to the debug serial.</p>
<h2>Other examples</h2>
<p>The 2-self-test example runs a bunch of tests to verify functionality. It also shows how to use most of the functions.</p>
<p>The 3-stop-sleep example shows how to use stop mode sleep (pin + time) to efficiently and safely manage the flash. Since stop mode sleep preserves the contents of RAM, you don't need to re-mount the file system or even the close and open the files. You can just continue where you left off.</p>
<h2>Resource usage</h2>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
