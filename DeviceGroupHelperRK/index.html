<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DeviceGroupHelperRK: DeviceGroupHelperRK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DeviceGroupHelperRK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">DeviceGroupHelperRK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Retrieve a device's device group from the device using a webhook</b></p>
<ul>
<li>Github repository: <a href="https://github.com/rickkas7/DeviceGroupHelperRK">https://github.com/rickkas7/DeviceGroupHelperRK</a></li>
<li>License: MIT (Can use in open or closed-source projects, including commercial projects. Attribution not required.)</li>
</ul>
<p>This is useful when you have a product and are using the device groups feature. Normally, use this to group related devices and control firmware releases. However, you can use this technique to read the device groups on-device, which would allow you to make decisions in device firmware based on group membership.</p>
<ul>
<li>You can choose when to update groups (manually, at startup, or periodically).</li>
<li>You can then either query whether the device is in a specific group using the previously cached group list. This is fast and does not require network access so you can use it in your code liberally.</li>
<li>Or, if you prefer, you can register a notification function that will call your function with an indication that the list was updated, and when individual groups are added or removed from the previous retrieval.</li>
</ul>
<h1>Requirements</h1>
<ul>
<li>This is only useful for product devices, as developer devices do not have device groups.</li>
<li>Because the device needs to subscribe to an event, the device must be claimed to an account. It can be a single account used for all devices, but it must be claimed. Unclaimed devices cannot subscribe to events.</li>
<li>A webhook is required, described below. The webhook needs to have a product access token in it.</li>
<li>Retrieving the group list will require at least two data operations (request and webhook response).</li>
</ul>
<h1>Getting an access token</h1>
<p>Since you probably will want a product access token (that allows access to a specific product only) and also a non-expiring one, you will probably want to use an oAuth client and the command line to generate one.</p>
<ul>
<li>In your product, open the <b>Authentication</b> tab. Make sure you've selected the one in your product, not in your developer account.</li>
</ul>
<div class="image">
<img src="authentication.png" alt=""/>
<div class="caption">
Authentication</div></div>
   <ul>
<li>Use the <b>New Client</b> button to create a new oAuth client. Select <b>Two-Legged Auth (Server)</b>. The Name is just for identifying it in the console, I entered <b>DeviceGroup</b>.</li>
</ul>
<div class="image">
<img src="create-client.png" alt=""/>
<div class="caption">
Authentication</div></div>
   <ul>
<li>Note the Client ID and Client Secret in the next screen. You'll need them in the next step.</li>
<li>Use the Particle APU to create a non-expiring product bearer token:</li>
</ul>
<div class="fragment"><div class="line">curl https://api.particle.io/oauth/token -u &quot;devicegroup-5835:3138afffffffffffffffffffffffffffffff7528&quot; -d grant_type=client_credentials -d expires_in=0</div>
</div><!-- fragment --><ul>
<li>Replace <code>devicegroup-5835</code> with the Client ID you just created</li>
<li>Replace <code>3138afffffffffffffffffffffffffffffff7528</code> with the Client Secret</li>
</ul>
<p>You should get back something like:</p>
<div class="fragment"><div class="line">{&quot;token_type&quot;:&quot;bearer&quot;,&quot;access_token&quot;:&quot;0a795effffffffffffffffffffffffffffff8b5b&quot;,&quot;expires_in&quot;:0}</div>
</div><!-- fragment --><ul>
<li>Note the access_token <code>0a795effffffffffffffffffffffffffffff8b5b</code>, you'll need that in the next step.</li>
</ul>
<h1>Creating the webhook</h1>
<ul>
<li>In the <b>Integrations</b> tab for your product, create a new Webhook.</li>
<li>Set the <b>Event Name</b> to be the event name you've configured in the library. The default is <code>G52ES20Q_DeviceGroup</code>. You do not need to change it from the default.</li>
<li>Set the <b>URL</b>. Be sure to change 7615 to the product ID of your product!</li>
</ul>
<div class="fragment"><div class="line">https://api.particle.io/v1/products/7615/devices/{{PARTICLE_DEVICE_ID}}</div>
</div><!-- fragment --><ul>
<li>Change <b>Request Type</b> to <b>GET</b>.</li>
<li>The <b>Request Format</b> should change the <b>Query Parameters</b> which is correct.</li>
<li>The checkbox <b>Only the device that triggers the webhook should receive its response</b> should be checked.</li>
<li>Click the disclosure triangle to expand the <b>Advanced Settings</b>.</li>
</ul>
<div class="image">
<img src="create-webhook.png" alt=""/>
<div class="caption">
Create Webhook</div></div>
   <ul>
<li>In the <b>Query Parameters</b> select <b>Custom</b> and add <code>access_token</code> (case-sensitive, and note the underscore) and the value is what you got in the access_token field of the curl response.</li>
<li>Leave the *HTTP Basic Auth** and <b>HTTP Headers</b> fields empty.</li>
<li>The <b>Response Topic</b> should already be <code>{{PARTICLE_DEVICE_ID}}/hook-response/{{PARTICLE_EVENT_NAME}}</code> and you can leave it set to that.</li>
<li>Edit the <b>Response Template</b> to be as follows. Be careful with the square and curly brackets; they must be exactly as shown.</li>
</ul>
<div class="fragment"><div class="line">{&quot;groups&quot;:[{{{groups}}}]}</div>
</div><!-- fragment --><div class="image">
<img src="webhook-advanced.png" alt=""/>
<div class="caption">
Advanced Settings</div></div>
   <h1>Device firmware</h1>
<p>This is the code in the examples/1-simple directory:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;DeviceGroupHelperRK.h&quot;</span></div>
<div class="line"> </div>
<div class="line">SerialLogHandler logHandler(LOG_LEVEL_TRACE);</div>
<div class="line"> </div>
<div class="line">SYSTEM_THREAD(ENABLED);</div>
<div class="line"> </div>
<div class="line">PRODUCT_ID(7615);   <span class="comment">// Change this to your product ID!</span></div>
<div class="line">PRODUCT_VERSION(1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">    <a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>()</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#acdf2d2fb545d1328abe8e86c9d225ea5">withRetrievalModeAtStart</a>()</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#aaf814601ee06ab2cf23aca3104cabfb5">setup</a>();   </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">    <a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>().<a class="code" href="class_device_group_helper.html#a13243a73bb51187dab222ad55153c76d">loop</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>().isInGroup(<span class="stringliteral">&quot;dev&quot;</span>)) {</div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">bool</span> notified = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (!notified) {</div>
<div class="line">            Log.info(<span class="stringliteral">&quot;is in group dev!&quot;</span>);</div>
<div class="line">            notified = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Digging in</h2>
<p>You need to include the library, such as by using the <b>Particle: Install Library</b> function in Particle Workbench or search the community libraries in the Web IDE for <b>DeviceGroupHelperRK</b>. Then you can include the header file</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;DeviceGroupHelperRK.h&quot;</span></div>
</div><!-- fragment --><p>This library is only useful for products, so you must update the <code>PRODUCT_ID</code> macro to match your product.</p>
<div class="fragment"><div class="line">PRODUCT_ID(7615);   <span class="comment">// Change this to your product ID!</span></div>
<div class="line">PRODUCT_VERSION(1);</div>
</div><!-- fragment --><p>You must initialize the library in <code>setup()</code>! The following configuration retrieves the device groups at startup once connected to the cloud.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">    <a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>()</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#acdf2d2fb545d1328abe8e86c9d225ea5">withRetrievalModeAtStart</a>()</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#aaf814601ee06ab2cf23aca3104cabfb5">setup</a>();   </div>
<div class="line">}</div>
</div><!-- fragment --><p>Make sure you also call <code><a class="el" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4" title="Get the singleton instance of this class.">DeviceGroupHelper::instance()</a>.loop()</code> from global <code>loop()</code>! If you don't call the setup and loop methods, the library will not work properly. You should call the loop frequently, preferably on every loop. It returns quickly if it does not have anything to do.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">    <a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>().<a class="code" href="class_device_group_helper.html#a13243a73bb51187dab222ad55153c76d">loop</a>();</div>
<div class="line">    <span class="comment">// ...</span></div>
</div><!-- fragment --><p>This code checks to see if the device belongs to a specific group and logs it if it is (once). You'd probably want to do something more useful here. <code>isInGroup()</code> is fast and efficient and you can call it frequently. It uses the previously retrieved value and does not access the network.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>().isInGroup(<span class="stringliteral">&quot;dev&quot;</span>)) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> notified = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (!notified) {</div>
<div class="line">        Log.info(<span class="stringliteral">&quot;is in group dev!&quot;</span>);</div>
<div class="line">        notified = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>With callback</h2>
<p>Alternatively, you can register a callback to be notified when group membership changes. This checks every 5 minutes for groups. You probably don't want to do it that frequently in real life.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">    <a class="code" href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a>()</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#ab1a084627a244f8df62fbfa23fa482ac">withRetrievalModePeriodic</a>(5min)</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#a5068197acbf538ae4e7c52c1fabb35be">withNotifyCallback</a>(groupCallback)</div>
<div class="line">        .<a class="code" href="class_device_group_helper.html#aaf814601ee06ab2cf23aca3104cabfb5">setup</a>();   </div>
<div class="line">}</div>
</div><!-- fragment --><p>The groupCallbacks function in examples/2-notify looks like this. It only logs messages; you probably want to do something more useful here.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> groupCallback(<a class="code" href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0">DeviceGroupHelper::NotificationType</a> notificationType, <span class="keyword">const</span> <span class="keywordtype">char</span> *group) {</div>
<div class="line">    <span class="keywordflow">switch</span>(notificationType) {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0ac5d66c61a88f1b214933a91fda1e13f5">DeviceGroupHelper::NotificationType::UPDATED</a>:</div>
<div class="line">        Log.info(<span class="stringliteral">&quot;updated groups&quot;</span>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0a55771bcb939a8afbf4d119d6e0099317">DeviceGroupHelper::NotificationType::ADDED</a>:</div>
<div class="line">        Log.info(<span class="stringliteral">&quot;added %s&quot;</span>, group);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0ab3461745d64b12346503b2980e436db5">DeviceGroupHelper::NotificationType::REMOVED</a>:</div>
<div class="line">        Log.info(<span class="stringliteral">&quot;removed %s&quot;</span>, group);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can respond to the <code>UPDATED</code> notification if you want to know if the list has been refreshed.</p>
<p>You can also use the <code>ADDED</code> or <code>REMOVED</code> notification to know if the group membership changed. You also get <code>ADDED</code> calls on the first retrieval of the list. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<div class="ttc" id="aclass_device_group_helper_html_a13243a73bb51187dab222ad55153c76d"><div class="ttname"><a href="class_device_group_helper.html#a13243a73bb51187dab222ad55153c76d">DeviceGroupHelper::loop</a></div><div class="ttdeci">void loop()</div><div class="ttdoc">You must call loop() from global application loop()!</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.cpp:25</div></div>
<div class="ttc" id="aclass_device_group_helper_html_a82b992441e25ce8db2007d04814be8b0ac5d66c61a88f1b214933a91fda1e13f5"><div class="ttname"><a href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0ac5d66c61a88f1b214933a91fda1e13f5">DeviceGroupHelper::NotificationType::UPDATED</a></div><div class="ttdeci">@ UPDATED</div><div class="ttdoc">The groups were updated. Use getGroups() to get a set of all group names.</div></div>
<div class="ttc" id="aclass_device_group_helper_html_aaf814601ee06ab2cf23aca3104cabfb5"><div class="ttname"><a href="class_device_group_helper.html#aaf814601ee06ab2cf23aca3104cabfb5">DeviceGroupHelper::setup</a></div><div class="ttdeci">void setup()</div><div class="ttdoc">You must call setup() from global application setup()!</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.cpp:16</div></div>
<div class="ttc" id="aclass_device_group_helper_html_a82b992441e25ce8db2007d04814be8b0ab3461745d64b12346503b2980e436db5"><div class="ttname"><a href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0ab3461745d64b12346503b2980e436db5">DeviceGroupHelper::NotificationType::REMOVED</a></div><div class="ttdeci">@ REMOVED</div><div class="ttdoc">This group was removed.</div></div>
<div class="ttc" id="aclass_device_group_helper_html_ab1a084627a244f8df62fbfa23fa482ac"><div class="ttname"><a href="class_device_group_helper.html#ab1a084627a244f8df62fbfa23fa482ac">DeviceGroupHelper::withRetrievalModePeriodic</a></div><div class="ttdeci">DeviceGroupHelper &amp; withRetrievalModePeriodic(unsigned long ms)</div><div class="ttdoc">Sets retrieve groups at start mode and periodically mode. This should be done before setup().</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.h:85</div></div>
<div class="ttc" id="aclass_device_group_helper_html_a82b992441e25ce8db2007d04814be8b0"><div class="ttname"><a href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0">DeviceGroupHelper::NotificationType</a></div><div class="ttdeci">NotificationType</div><div class="ttdoc">Used for the notify callback to specify what is being notified of.</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.h:42</div></div>
<div class="ttc" id="aclass_device_group_helper_html_a5068197acbf538ae4e7c52c1fabb35be"><div class="ttname"><a href="class_device_group_helper.html#a5068197acbf538ae4e7c52c1fabb35be">DeviceGroupHelper::withNotifyCallback</a></div><div class="ttdeci">DeviceGroupHelper &amp; withNotifyCallback(std::function&lt; void(NotificationType, const char *)&gt; notifyCallback)</div><div class="ttdoc">Sets a function to be called when the group list is updated.</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.h:149</div></div>
<div class="ttc" id="aclass_device_group_helper_html_a47b4e36d163d5b348519ffa64ec38df4"><div class="ttname"><a href="class_device_group_helper.html#a47b4e36d163d5b348519ffa64ec38df4">DeviceGroupHelper::instance</a></div><div class="ttdeci">static DeviceGroupHelper &amp; instance()</div><div class="ttdoc">Get the singleton instance of this class.</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.cpp:8</div></div>
<div class="ttc" id="aclass_device_group_helper_html_a82b992441e25ce8db2007d04814be8b0a55771bcb939a8afbf4d119d6e0099317"><div class="ttname"><a href="class_device_group_helper.html#a82b992441e25ce8db2007d04814be8b0a55771bcb939a8afbf4d119d6e0099317">DeviceGroupHelper::NotificationType::ADDED</a></div><div class="ttdeci">@ ADDED</div><div class="ttdoc">This group was added.</div></div>
<div class="ttc" id="aclass_device_group_helper_html_acdf2d2fb545d1328abe8e86c9d225ea5"><div class="ttname"><a href="class_device_group_helper.html#acdf2d2fb545d1328abe8e86c9d225ea5">DeviceGroupHelper::withRetrievalModeAtStart</a></div><div class="ttdeci">DeviceGroupHelper &amp; withRetrievalModeAtStart()</div><div class="ttdoc">Sets retrieve groups at start mode. This should be done before setup().</div><div class="ttdef"><b>Definition:</b> DeviceGroupHelperRK.h:76</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
